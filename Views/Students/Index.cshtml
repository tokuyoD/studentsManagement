@model IEnumerable<StudentManagement.Models.Student>
@using Microsoft.AspNetCore.Identity

<h2>學生列表</h2>

@if (User.IsInRole("Teacher") || User.IsInRole("Admin"))
{
    <p>
        <a class="btn btn-success mb-2" asp-action="Create">新增學生</a>
    </p>
}

<form method="get" class="mb-3 d-flex">
    <input type="text" name="searchString" class="form-control me-2" placeholder="搜尋姓名" value="@ViewBag.SearchString" />
    <button type="submit" class="btn btn-primary">搜尋</button>
</form>

<table class="table table-striped table-bordered table-responsive">
    <thead class="table-dark">
        <tr>
            <th>姓名</th>
            <th>年齡</th>
            <th>Email</th>
            <th>性別</th>
            <th>系所</th>
            <th>年級</th>
            <th>班別</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var s in Model)
        {
            string dept = "", year = "", clsSection = "";
            if (!string.IsNullOrEmpty(s.Class))
            {
                int firstDigitIndex = -1;
                for (int i = 0; i < s.Class.Length; i++)
                {
                    if (char.IsDigit(s.Class[i]))
                    {
                        firstDigitIndex = i;
                        break;
                    }
                }

                if (firstDigitIndex >= 0)
                {
                    dept = s.Class.Substring(0, firstDigitIndex);        // 系所
                    string rest = s.Class.Substring(firstDigitIndex);
                    year = rest.Substring(0, 1);                         // 年級
                    clsSection = rest.Length > 1 ? rest.Substring(1) : ""; // 班別
                }
            }

            string genderDisplay = s.Gender == "Male" ? "男" : s.Gender == "Female" ? "女" : s.Gender;

            <tr>
                <td>@s.Name</td>
                <td>@s.Age</td>
                <td>@s.Email</td>
                <td>@genderDisplay</td>
                <td>@dept</td>
                <td>@year</td>
                <td>@clsSection</td>
                <td>
                    <a class="btn btn-primary btn-sm me-1" asp-action="Details" asp-route-id="@s.Id">查看</a>

                    @if (User.IsInRole("Teacher") || User.IsInRole("Admin"))
                    {
                        <a class="btn btn-warning btn-sm me-1" asp-action="Edit" asp-route-id="@s.Id">編輯</a>
                    }

                    @if (User.IsInRole("Admin"))
                    {
                        <a class="btn btn-danger btn-sm" asp-action="Delete" asp-route-id="@s.Id">刪除</a>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

@if (ViewBag.TotalPages > 1)
{
    <nav aria-label="Page navigation">
        <ul class="pagination">
            @for (int i = 1; i <= ViewBag.TotalPages; i++)
            {
                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                    <a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-searchString="@ViewBag.SearchString">@i</a>
                </li>
            }
        </ul>
    </nav>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
